<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scripture Scribbles Reader</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f5f5f5;
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        .toolbar {
            background: #2c3e50;
            color: white;
            padding: 15px 30px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .toolbar h1 {
            font-size: 1.4em;
            margin-bottom: 12px;
            font-weight: 600;
            color: #ecf0f1;
        }

        .quick-modes {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #34495e;
            flex-wrap: wrap;
        }

        .mode-divider {
            width: 1px;
            height: 30px;
            background: #34495e;
            margin: 0 5px;
        }

        /* Toolbar collapse */
        #toolbar-content {
            max-height: 1000px;
            overflow: hidden;
            transition: max-height 0.3s ease, opacity 0.3s ease;
            opacity: 1;
        }

        #toolbar-content.collapsed {
            max-height: 0;
            opacity: 0;
        }

        #toolbar-toggle {
            transition: transform 0.3s ease;
        }

        #toolbar-toggle.collapsed {
            transform: rotate(-90deg);
        }

        .mode-btn {
            padding: 8px 16px;
            background: #34495e;
            border: 2px solid transparent;
            color: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.2s;
        }

        .mode-btn:hover {
            background: #4a5f7f;
        }

        .mode-btn.active {
            background: #3498db;
            border-color: #5dade2;
        }

        .font-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .font-controls span {
            font-size: 0.85em;
        }

        .icon-btn {
            background: #34495e;
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1.1em;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .icon-btn:hover {
            background: #4a5f7f;
        }

        .icon-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .font-size-display {
            min-width: 45px;
            text-align: center;
            font-size: 0.9em;
        }

        /* Navigation section */
        .navigation {
            display: flex;
            gap: 15px;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #34495e;
            flex-wrap: wrap;
        }

        .nav-btn {
            padding: 8px 16px;
            background: #34495e;
            border: none;
            color: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .nav-btn:hover:not(:disabled) {
            background: #4a5f7f;
        }

        .nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .chapter-selector {
            flex: 1;
            min-width: 200px;
        }

        .chapter-selector select {
            width: 100%;
            padding: 8px 12px;
            background: #34495e;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 0.9em;
            cursor: pointer;
        }

        .chapter-selector select:focus {
            outline: 2px solid #3498db;
        }

        /* Welcome/Setup screen */
        .welcome-screen {
            padding: 60px 40px;
            text-align: center;
        }

        .welcome-screen h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 2em;
        }

        .welcome-screen p {
            color: #7f8c8d;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .setup-steps {
            max-width: 600px;
            margin: 0 auto 40px;
            text-align: left;
        }

        .step {
            background: #ecf0f1;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }

        .step h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .step p {
            color: #555;
            font-size: 0.95em;
            margin-bottom: 0;
        }

        .primary-btn {
            padding: 15px 30px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 1.1em;
            cursor: pointer;
            transition: background 0.2s;
        }

        .primary-btn:hover {
            background: #2980b9;
        }

        .secondary-btn {
            padding: 12px 24px;
            background: #95a5a6;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.95em;
            cursor: pointer;
            margin-top: 15px;
            transition: background 0.2s;
        }

        .secondary-btn:hover {
            background: #7f8c8d;
        }

        /* Settings */
        .settings-header {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            padding: 10px 0;
            user-select: none;
        }

        .settings-header:hover {
            opacity: 0.8;
        }

        .collapse-icon {
            transition: transform 0.2s;
            font-size: 0.9em;
        }

        .collapse-icon.collapsed {
            transform: rotate(-90deg);
        }

        .controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            overflow: hidden;
            transition: max-height 0.3s ease, opacity 0.3s ease;
        }

        .controls.collapsed {
            max-height: 0;
            opacity: 0;
        }

        .control-section {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .control-section-title {
            font-size: 0.75em;
            text-transform: uppercase;
            color: #95a5a6;
            letter-spacing: 0.5px;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .control-group label {
            font-size: 0.9em;
            cursor: pointer;
            user-select: none;
        }

        .control-group input[type="checkbox"] {
            cursor: pointer;
        }

        /* Content area */
        .content {
            padding: 40px 80px;
            font-size: 16px;
        }

        .center-me {
            text-align: center;
            color: #7f8c8d;
            font-size: 0.9em;
            margin: 20px 0;
            padding: 10px;
            border-top: 1px solid #ecf0f1;
            border-bottom: 1px solid #ecf0f1;
        }

        .verse-container {
            display: flex;
            margin: 15px 0;
            position: relative;
            padding-left: 100px;
        }

        .verse-container::before {
            content: '';
            position: absolute;
            left: 0;
            top: -5px;
            bottom: -5px;
            width: 100px;
            pointer-events: auto;
        }

        .verse-number {
            min-width: 40px;
            font-weight: bold;
            color: #e74c3c;
            font-size: 0.85em;
            padding-top: 2px;
            flex-shrink: 0;
            position: absolute;
            left: 60px;
        }

        .verse-text {
            flex: 1;
            position: relative;
            cursor: text;
        }

        /* Margin action icons */
        .verse-actions {
            position: absolute;
            left: 60px;
            top: -20px;
            display: flex;
            flex-direction: row;
            gap: 3px;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 10;
        }

        .verse-container:hover .verse-actions {
            opacity: 0.7;
        }

        .verse-action-btn {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: none;
            background: #ecf0f1;
            cursor: pointer;
            font-size: 0.75em;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .verse-action-btn:hover {
            opacity: 1;
            transform: scale(1.1);
            background: #3498db;
        }

        body.dark-mode .verse-action-btn {
            background: #34495e;
        }

        body.dark-mode .verse-action-btn:hover {
            background: #3498db;
        }

        /* Floating highlight toolbar */
        .floating-toolbar {
            position: absolute;
            background: white;
            border: 2px solid #3498db;
            border-radius: 8px;
            padding: 8px;
            display: none;
            gap: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 1000;
        }

        .floating-toolbar.visible {
            display: flex;
        }

        .highlight-btn {
            width: 32px;
            height: 32px;
            border-radius: 4px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
        }

        .highlight-btn:hover {
            transform: scale(1.1);
            border-color: #2c3e50;
        }

        .highlight-btn[data-color="1"] { background: #ffeb3b; }
        .highlight-btn[data-color="2"] { background: #a5d6a7; }
        .highlight-btn[data-color="3"] { background: #f8bbd0; }
        .highlight-btn[data-color="4"] { background: #81d4fa; }
        .highlight-btn[data-color="5"] { background: #ffcc80; }
        .highlight-btn[data-color="6"] { background: #ce93d8; }

        body.dark-mode .floating-toolbar {
            background: #2d2d2d;
            border-color: #3498db;
        }

        body.dark-mode .highlight-btn[data-color="1"] { background: #665500; }
        body.dark-mode .highlight-btn[data-color="2"] { background: #2d5a2d; }
        body.dark-mode .highlight-btn[data-color="3"] { background: #6b3d52; }
        body.dark-mode .highlight-btn[data-color="4"] { background: #2d5a6b; }
        body.dark-mode .highlight-btn[data-color="5"] { background: #6b4d2d; }
        body.dark-mode .highlight-btn[data-color="6"] { background: #5a3d6b; }

        /* Margin indicators */
        .verse-text::before {
            content: '';
            position: absolute;
            left: -10px;
            top: 0;
            bottom: 0;
            width: 3px;
            background: transparent;
        }

        /* Highlight marker (yellow) */
        body.show-highlight-markers .verse-text.has-highlight::before {
            background: #ffc107;
        }

        /* Note marker (blue) */
        body.show-note-markers .verse-text.has-note::before {
            background: #2196f3;
        }

        /* Tag marker (purple) */
        body.show-tag-markers .verse-text.has-tag::before {
            background: #9c27b0;
        }

        /* Two markers combinations */
        body.show-highlight-markers.show-note-markers .verse-text.has-highlight.has-note::before {
            background: linear-gradient(to bottom, #ffc107 50%, #2196f3 50%);
        }

        body.show-highlight-markers.show-tag-markers .verse-text.has-highlight.has-tag::before {
            background: linear-gradient(to bottom, #ffc107 50%, #9c27b0 50%);
        }

        body.show-note-markers.show-tag-markers .verse-text.has-note.has-tag::before {
            background: linear-gradient(to bottom, #2196f3 50%, #9c27b0 50%);
        }

        /* Three markers */
        body.show-highlight-markers.show-note-markers.show-tag-markers .verse-text.has-highlight.has-note.has-tag::before {
            background: linear-gradient(to bottom, #ffc107 33.33%, #2196f3 33.33%, #2196f3 66.66%, #9c27b0 66.66%);
        }

        /* Full highlight mode */
        body.highlight-mode-full .verse-text.has-highlight,
        body.highlight-mode-full .verse-text.has-note,
        body.highlight-mode-full .verse-text.has-tag {
            background: #fff3cd;
            padding: 5px;
            margin: -5px;
            border-radius: 3px;
        }

        /* Verse indicators */
        .verse-indicators {
            display: inline-flex;
            gap: 4px;
            margin-left: 8px;
            font-size: 0.85em;
        }

        .indicator-note,
        .indicator-tag {
            opacity: 0.6;
        }

        .indicator-note {
            color: #2196f3;
        }

        .indicator-tag {
            color: #9c27b0;
        }

        /* Highlights */
        .highlight-1 { background-color: #ffeb3b; }
        .highlight-2 { background-color: #a5d6a7; }
        .highlight-3 { background-color: #f8bbd0; }
        .highlight-4 { background-color: #81d4fa; }
        .highlight-5 { background-color: #ffcc80; }
        .highlight-6 { background-color: #ce93d8; }

        /* Notes */
        .note {
            border-left: 4px solid #2196f3;
            padding: 10px 15px;
            margin: 10px 0 10px 40px;
            border-radius: 4px;
            font-size: 0.95em;
        }

        body.note-style-highlighted .note {
            background: #e3f2fd;
        }

        body.note-style-plain .note {
            background: transparent;
        }

        .note::before {
            content: "‚ìù Note";
            font-weight: bold;
            color: #1976d2;
            margin-right: 8px;
            font-size: 0.85em;
        }

        .note-verses {
            color: #1976d2;
            font-size: 0.85em;
            font-weight: bold;
            display: inline;
            margin-right: 8px;
        }

        /* Tags */
        .tags {
            border-left: 4px solid #9c27b0;
            padding: 8px 15px;
            margin: 10px 0 10px 40px;
            border-radius: 4px;
            font-size: 0.9em;
        }

        body.tag-style-highlighted .tags {
            background: #f3e5f5;
        }

        body.tag-style-plain .tags {
            background: transparent;
        }

        .tags::before {
            content: "‚ì£ Tags";
            font-weight: bold;
            color: #7b1fa2;
            display: block;
            margin-bottom: 5px;
            font-size: 0.85em;
        }

        body.dark-mode .tags::before {
            color: #ce93d8;
        }

        .tag {
            display: inline-block;
            background: #ce93d8;
            color: #4a148c;
            padding: 2px 8px;
            margin: 2px;
            border-radius: 12px;
            font-size: 0.85em;
        }

        h1 {
            font-size: 2em;
            margin-bottom: 20px;
            color: #2c3e50;
            text-align: center;
        }

        .wikilink {
            color: #3498db;
            text-decoration: none;
            border-bottom: 1px dotted #3498db;
        }

        .wikilink:hover {
            color: #2980b9;
            border-bottom: 1px solid #2980b9;
        }

        /* Hide classes */
        body:not(.show-highlights) .highlight-1,
        body:not(.show-highlights) .highlight-2,
        body:not(.show-highlights) .highlight-3,
        body:not(.show-highlights) .highlight-4,
        body:not(.show-highlights) .highlight-5,
        body:not(.show-highlights) .highlight-6 {
            background-color: transparent !important;
        }

        body:not(.show-notes) .note {
            display: none;
        }

        body:not(.show-tags) .tags {
            display: none;
        }

        body:not(.show-indicators) .verse-indicators {
            display: none;
        }

        /* Dark mode */
        body.dark-mode {
            background: #1a1a1a;
            color: #e0e0e0;
        }

        body.dark-mode .container {
            background: #2d2d2d;
        }

        body.dark-mode .content {
            color: #e0e0e0;
        }

        body.dark-mode h1 {
            color: #f0f0f0;
        }

        body.dark-mode .center-me {
            color: #999;
            border-top-color: #3a3a3a;
            border-bottom-color: #3a3a3a;
        }

        body.dark-mode .verse-number {
            color: #e74c3c;
        }

        body.dark-mode .note {
            border-left-color: #2196f3;
        }

        body.dark-mode.note-style-highlighted .note {
            background: #1a2a3a;
        }

        body.dark-mode .tags {
            border-left-color: #9c27b0;
        }

        body.dark-mode.tag-style-highlighted .tags {
            background: #2a1a2a;
        }

        body.dark-mode .tag {
            background: #4a2a5a;
            color: #d8a8e8;
        }

        body.dark-mode.highlight-mode-full .verse-text.has-highlight,
        body.dark-mode.highlight-mode-full .verse-text.has-note,
        body.dark-mode.highlight-mode-full .verse-text.has-tag {
            background: #3a3520;
        }

        body.dark-mode .wikilink {
            color: #5dade2;
            border-bottom-color: #5dade2;
        }

        body.dark-mode .wikilink:hover {
            color: #85c1e9;
            border-bottom-color: #85c1e9;
        }

        body.dark-mode .highlight-1 { background-color: #665500; }
        body.dark-mode .highlight-2 { background-color: #2d5a2d; }
        body.dark-mode .highlight-3 { background-color: #6b3d52; }
        body.dark-mode .highlight-4 { background-color: #2d5a6b; }
        body.dark-mode .highlight-5 { background-color: #6b4d2d; }
        body.dark-mode .highlight-6 { background-color: #5a3d6b; }

        body.dark-mode .welcome-screen h2 {
            color: #ecf0f1;
        }

        body.dark-mode .welcome-screen p {
            color: #95a5a6;
        }

        body.dark-mode .step {
            background: #34495e;
            border-left-color: #3498db;
        }

        body.dark-mode .step h3 {
            color: #ecf0f1;
        }

        body.dark-mode .step p {
            color: #bdc3c7;
        }

        /* Font sizes */
        body.font-small .content {
            font-size: 14px;
        }

        body.font-large .content {
            font-size: 18px;
        }

        body.font-xlarge .content {
            font-size: 20px;
        }

        body.font-xxlarge .content {
            font-size: 22px;
        }

        .hidden {
            display: none;
        }

        /* Save status indicator */
        .save-status {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 8px 16px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border-radius: 20px;
            font-size: 0.9em;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .save-status.visible {
            opacity: 1;
        }

        .save-status.saving {
            background: rgba(52, 152, 219, 0.9);
        }

        .save-status.saved {
            background: rgba(39, 174, 96, 0.9);
        }

        body.dark-mode .save-status {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
        }

        /* Modal overlay */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .modal-overlay.visible {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }

        body.dark-mode .modal {
            background: #2d2d2d;
        }

        .modal h2 {
            margin-top: 0;
            margin-bottom: 20px;
            color: #2c3e50;
        }

        body.dark-mode .modal h2 {
            color: #ecf0f1;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.95em;
            transition: background 0.2s;
        }

        .modal-btn.primary {
            background: #3498db;
            color: white;
        }

        .modal-btn.primary:hover {
            background: #2980b9;
        }

        .modal-btn.secondary {
            background: #95a5a6;
            color: white;
        }

        .modal-btn.secondary:hover {
            background: #7f8c8d;
        }

        .modal textarea {
            width: 100%;
            min-height: 100px;
            padding: 10px;
            border: 2px solid #bdc3c7;
            border-radius: 6px;
            font-family: inherit;
            font-size: 0.95em;
            resize: vertical;
        }

        body.dark-mode .modal textarea {
            background: #34495e;
            color: #ecf0f1;
            border-color: #555;
        }

        .modal input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 2px solid #bdc3c7;
            border-radius: 6px;
            font-family: inherit;
            font-size: 0.95em;
        }

        body.dark-mode .modal input[type="text"] {
            background: #34495e;
            color: #ecf0f1;
            border-color: #555;
        }

        .modal label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        body.dark-mode .modal label {
            color: #ecf0f1;
        }

        .verse-range-help {
            font-size: 0.85em;
            color: #7f8c8d;
            margin-top: 5px;
        }

        /* Colour picker grid */
        .colour-picker-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 15px 0;
        }

        .colour-option {
            height: 50px;
            border-radius: 8px;
            border: 3px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
        }

        .colour-option:hover {
            transform: scale(1.05);
            border-color: #2c3e50;
        }

        .colour-option.selected {
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.3);
        }

        /* Tag input chips */
        .tag-chip {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            background: #ce93d8;
            color: #4a148c;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.85em;
        }

        .tag-chip-remove {
            cursor: pointer;
            font-weight: bold;
            padding: 0 3px;
        }

        .tag-chip-remove:hover {
            color: #d32f2f;
        }

        body.dark-mode .tag-chip {
            background: #4a2a5a;
            color: #d8a8e8;
        }

        /* Delete buttons for annotations */
        .annotation-delete {
            cursor: pointer;
            color: #95a5a6;
            margin-left: 10px;
            font-size: 0.9em;
            transition: color 0.2s;
        }

        .annotation-delete:hover {
            color: #e74c3c;
        }
    </style>
</head>
<body class="show-highlights show-notes show-tags show-indicators show-highlight-markers show-note-markers show-tag-markers highlight-mode-margin note-style-highlighted tag-style-highlighted">
    <div class="container">
        <div class="toolbar">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h1 style="margin: 0;">Scripture Scribbles Reader</h1>
                <button class="icon-btn" id="toolbar-toggle" title="Toggle toolbar" style="font-size: 1.5em;">‚ñº</button>
            </div>

            <div id="toolbar-content" class="quick-modes">
                <button class="mode-btn" data-mode="reading">üìñ Reading</button>
                <button class="mode-btn" data-mode="study">üìù Study</button>
                <button class="mode-btn" data-mode="church">‚õ™ Church</button>
                <button class="mode-btn" data-mode="custom">‚öôÔ∏è Custom</button>

                <div class="mode-divider"></div>

                <div class="font-controls">
                    <span>Notes:</span>
                    <select id="annotation-set-select" style="padding: 6px 12px; background: #34495e; color: white; border: none; border-radius: 4px; font-size: 0.9em; cursor: pointer;">
                        <option value="Study">Study</option>
                        <option value="Church">Church</option>
                        <option value="HomeGroup">Home Group</option>
                        <option value="Personal">Personal</option>
                    </select>
                </div>

                <div class="mode-divider"></div>

                <div class="font-controls">
                    <span>Font:</span>
                    <button class="icon-btn" id="font-decrease" title="Decrease font size">-</button>
                    <span class="font-size-display" id="font-size-label">100%</span>
                    <button class="icon-btn" id="font-increase" title="Increase font size">+</button>
                </div>

                <button class="icon-btn" id="dark-mode-toggle" title="Toggle dark mode">üåô</button>
            </div>

            <!-- Navigation (hidden until folder loaded) -->
            <div class="navigation hidden" id="navigation">
                <button class="nav-btn" id="prev-chapter" disabled>
                    ‚Üê Previous
                </button>

                <div class="chapter-selector">
                    <select id="book-select" style="flex: 1; margin-right: 10px;">
                        <option value="">Select a book...</option>
                    </select>
                    <select id="chapter-select" style="flex: 1;">
                        <option value="">Select a chapter...</option>
                    </select>
                </div>

                <button class="nav-btn" id="next-chapter" disabled>
                    Next ‚Üí
                </button>
            </div>

            <div class="settings-header" id="settings-toggle">
                <span class="collapse-icon collapsed">‚ñº</span>
                <span style="font-size: 0.9em;">Advanced Settings</span>
            </div>

            <div class="controls collapsed" id="settings-panel">
                <div class="control-section">
                    <div class="control-section-title">Text</div>
                    <div class="control-group">
                        <input type="checkbox" id="toggle-highlights" checked>
                        <label for="toggle-highlights">Show Highlights</label>
                    </div>
                    <div class="control-group">
                        <input type="checkbox" id="toggle-highlight-markers" checked>
                        <label for="toggle-highlight-markers">Highlight Markers</label>
                    </div>
                </div>

                <div class="control-section">
                    <div class="control-section-title">Notes</div>
                    <div class="control-group">
                        <input type="checkbox" id="toggle-notes" checked>
                        <label for="toggle-notes">Show Notes</label>
                    </div>
                    <div class="control-group">
                        <input type="checkbox" id="toggle-note-bg" checked>
                        <label for="toggle-note-bg">Note Background</label>
                    </div>
                    <div class="control-group">
                        <input type="checkbox" id="toggle-note-markers" checked>
                        <label for="toggle-note-markers">Note Markers</label>
                    </div>
                </div>

                <div class="control-section">
                    <div class="control-section-title">Tags</div>
                    <div class="control-group">
                        <input type="checkbox" id="toggle-tags" checked>
                        <label for="toggle-tags">Show Tags</label>
                    </div>
                    <div class="control-group">
                        <input type="checkbox" id="toggle-tag-bg" checked>
                        <label for="toggle-tag-bg">Tag Background</label>
                    </div>
                    <div class="control-group">
                        <input type="checkbox" id="toggle-tag-markers" checked>
                        <label for="toggle-tag-markers">Tag Markers</label>
                    </div>
                </div>

                <div class="control-section">
                    <div class="control-section-title">Indicators</div>
                    <div class="control-group">
                        <input type="checkbox" id="toggle-indicators" checked>
                        <label for="toggle-indicators">Icons (‚ìù ‚ì£)</label>
                    </div>
                    <div class="control-group">
                        <input type="checkbox" id="toggle-full-highlight">
                        <label for="toggle-full-highlight">Full Highlight</label>
                    </div>
                </div>
            </div>
            </div>
        </div>

        <!-- Welcome screen (shown on first load) -->
        <div class="welcome-screen" id="welcome-screen">
            <h2>Welcome to Scripture Scribbles Reader</h2>
            <p>Your personal Bible study tool with highlights, notes, and tags</p>

            <div class="setup-steps">
                <div class="step">
                    <h3>Step 1: Get a Bible</h3>
                    <p>Download a free public domain Bible in markdown format, or use your existing markdown Bible files.</p>
                </div>

                <div class="step">
                    <h3>Step 2: Select Your Folder</h3>
                    <p>Point Scripture Scribbles Reader to your Bible folder. Your files stay on your device - we never upload anything.</p>
                </div>

                <div class="step">
                    <h3>Step 3: Start Reading & Studying</h3>
                    <p>Add highlights, notes, and tags. Everything saves directly to your markdown files.</p>
                </div>
            </div>

            <button class="primary-btn" id="select-folder-btn">üìÅ Select Bible Folder</button>
            <br>
            <button class="secondary-btn" id="download-bible-btn">üì• Download Free Bible (WEB)</button>
        </div>

        <!-- Content area (hidden until folder loaded) -->
        <div class="content hidden" id="content"></div>

        <!-- Footer -->
        <div style="text-align: center; padding: 20px; color: #95a5a6; font-size: 0.85em; margin-top: 40px;">
            Scripture Scribbles v1.0.0 |
            <a href="#" id="report-bug-link" style="color: #3498db; text-decoration: none;">Report a Bug</a> |
            <a href="https://scripturescribbles.co.uk" style="color: #3498db; text-decoration: none;">scripturescribbles.co.uk</a>
        </div>
    </div>

    <!-- Floating highlight toolbar -->
    <div class="floating-toolbar" id="floating-toolbar">
        <button class="highlight-btn" data-color="1" title="Yellow"></button>
        <button class="highlight-btn" data-color="2" title="Green"></button>
        <button class="highlight-btn" data-color="3" title="Pink"></button>
        <button class="highlight-btn" data-color="4" title="Blue"></button>
        <button class="highlight-btn" data-color="5" title="Orange"></button>
        <button class="highlight-btn" data-color="6" title="Purple"></button>
        <button class="highlight-btn" data-color="clear" title="Clear" style="background: #ecf0f1; color: #2c3e50; font-size: 0.7em; font-weight: bold;">‚úï</button>
    </div>

    <!-- Save status indicator -->
    <div class="save-status" id="save-status"></div>

    <!-- Modals -->
    <!-- Note dialog -->
    <div class="modal-overlay" id="note-modal-overlay">
        <div class="modal">
            <h2>Add Note</h2>
            <div>
                <label for="note-verse-range">Apply to verses:</label>
                <input type="text" id="note-verse-range" placeholder="e.g., 3 or 3-5 or 3,7,12">
                <div class="verse-range-help">Leave empty for current verse, or specify range (3-5) or multiple (3,7,12)</div>
            </div>
            <div style="margin-top: 15px;">
                <label for="note-text">Note text:</label>
                <textarea id="note-text" placeholder="Enter your note here..."></textarea>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn secondary" id="note-cancel">Cancel</button>
                <button class="modal-btn primary" id="note-save">Add Note</button>
            </div>
        </div>
    </div>

    <!-- Tag dialog -->
    <div class="modal-overlay" id="tag-modal-overlay">
        <div class="modal">
            <h2>Add Tags</h2>
            <div>
                <label for="tag-verse-range">Apply to verses:</label>
                <input type="text" id="tag-verse-range" placeholder="e.g., 3 or 3-5 or 3,7,12">
                <div class="verse-range-help">Leave empty for current verse, or specify range (3-5) or multiple (3,7,12)</div>
            </div>
            <div style="margin-top: 15px;">
                <label for="tag-text">Tags:</label>
                <input type="text" id="tag-text" placeholder="Type tag and press Tab (e.g., theology)">
                <div id="tag-chips" style="margin-top: 10px; display: flex; flex-wrap: wrap; gap: 5px;"></div>
                <div class="verse-range-help">Press Tab or Enter to add each tag. # added automatically.</div>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn secondary" id="tag-cancel">Cancel</button>
                <button class="modal-btn primary" id="tag-save">Add Tags</button>
            </div>
        </div>
    </div>

    <!-- Highlight picker dialog (for full verse) -->
    <div class="modal-overlay" id="highlight-modal-overlay">
        <div class="modal">
            <h2>Highlight Verse</h2>
            <p>Select a colour to highlight the entire verse:</p>
            <div class="colour-picker-grid">
                <div class="colour-option" data-color="1" style="background: #ffeb3b;" title="Yellow"></div>
                <div class="colour-option" data-color="2" style="background: #a5d6a7;" title="Green"></div>
                <div class="colour-option" data-color="3" style="background: #f8bbd0;" title="Pink"></div>
                <div class="colour-option" data-color="4" style="background: #81d4fa;" title="Blue"></div>
                <div class="colour-option" data-color="5" style="background: #ffcc80;" title="Orange"></div>
                <div class="colour-option" data-color="6" style="background: #ce93d8;" title="Purple"></div>
                <div class="colour-option" data-color="clear" style="background: #ecf0f1; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #2c3e50; font-size: 1.2em;" title="Clear Highlight">‚úï</div>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn secondary" id="highlight-cancel">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Bug report modal -->
    <div class="modal-overlay" id="bug-report-modal-overlay" style="display: none;">
        <div class="modal" style="max-width: 500px;">
            <h2>üêõ Report a Bug</h2>
            <p>Help improve Scripture Scribbles by reporting issues.</p>

            <form id="bug-report-form" style="display: flex; flex-direction: column; gap: 15px;">
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">What went wrong?</label>
                    <textarea id="bug-description" required rows="4" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: inherit; resize: vertical;" placeholder="Describe the issue..."></textarea>
                </div>

                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Steps to reproduce:</label>
                    <textarea id="bug-steps" rows="3" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: inherit; resize: vertical;" placeholder="1. Click on...\n2. Then..."></textarea>
                </div>

                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Your email (optional):</label>
                    <input type="email" id="bug-email" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" placeholder="your@email.com">
                </div>

                <div class="modal-buttons">
                    <button type="button" class="modal-btn secondary" id="bug-cancel">Cancel</button>
                    <button type="submit" class="modal-btn primary">Submit Bug Report</button>
                </div>
            </form>

            <div id="bug-success" style="display: none; text-align: center; padding: 20px;">
                <p style="color: #27ae60; font-size: 1.1em; margin-bottom: 10px;">‚úÖ Bug report submitted!</p>
                <p style="color: #7f8c8d;">Thank you for helping improve Scripture Scribbles.</p>
                <button class="modal-btn primary" id="bug-close">Close</button>
            </div>
        </div>
    </div>

    <!-- Welcome modal (first-time users) -->
    <div class="modal-overlay" id="welcome-modal-overlay" style="display: none;">
        <div class="modal" style="max-width: 600px;">
            <h2>üìñ Welcome to Scripture Scribbles</h2>
            <p style="font-size: 1.1em; margin-bottom: 20px;">Your Bible study tool that keeps everything local and private.</p>

            <div style="background: #e8f4fd; padding: 15px; border-radius: 8px; border-left: 4px solid #3498db; margin-bottom: 20px;">
                <h3 style="margin-top: 0; color: #2c3e50;">Perfect for Obsidian Users!</h3>
                <p style="margin-bottom: 0; color: #34495e;">
                    Use your existing Bible markdown files from Obsidian. Your files stay untouched - all annotations are saved separately in JSON format.
                </p>
            </div>

            <h3>What you'll need:</h3>
            <ul style="line-height: 1.8; margin-left: 20px;">
                <li>‚úÖ Chrome, Edge, or Brave browser</li>
                <li>‚úÖ Bible files in markdown format (one file per chapter)</li>
                <li>‚úÖ Permission to access your Bible folder</li>
            </ul>

            <h3>How it works:</h3>
            <ol style="line-height: 1.8; margin-left: 20px;">
                <li>Click "Select Your Bible Folder"</li>
                <li>Navigate to your Bible root folder (e.g., "WEB", "KJV", "A Faithful Version")</li>
                <li>Grant read/write permissions</li>
                <li>Start highlighting, adding notes, and tagging verses</li>
                <li>Everything saves automatically to <code>.annotations/</code> folder</li>
            </ol>

            <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #f39c12; margin: 20px 0;">
                <p style="margin: 0; color: #856404;">
                    <strong>üîí Privacy First:</strong> All data stays on your device. No cloud. No tracking. No accounts.
                </p>
            </div>

            <div class="modal-buttons">
                <button class="modal-btn primary" id="welcome-start" style="font-size: 1.1em; padding: 12px 30px;">Let's Go!</button>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let bibleFolder = null;
        let fileIndex = [];
        let bookIndex = {}; // { "046 - 1 Peter": [...chapters] }
        let currentFile = null;
        let currentFileHandle = null;
        let currentMode = 'study';
        let isProgrammaticChange = false;

        // Annotations system
        let annotationSets = {}; // { "Study": { handle, data }, "Church": { handle, data } }
        let currentAnnotationSet = localStorage.getItem('annotationSet') || 'Study';
        let currentAnnotations = {}; // Loaded annotations for current book

        // Editing state (removed unsavedEdits - now auto-save directly)
        let currentOriginalMarkdown = '';
        let currentSelectedVerse = null;

        // Auto-save state
        let saveTimeout = null;
        let saveStatusTimeout = null;

        // File System Access API support check
        if (!('showDirectoryPicker' in window)) {
            alert('Your browser does not support the File System Access API. Please use Chrome, Edge, or another Chromium-based browser.');
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initializeApp();
        });

        async function initializeApp() {
            setupEventListeners();
            setupEditingHandlers();
            loadSettings();
            checkFirstTimeUser();
        }

        function checkFirstTimeUser() {
            const hasVisited = localStorage.getItem('hasVisitedBefore');
            if (!hasVisited) {
                // Show welcome modal
                document.getElementById('welcome-modal-overlay').style.display = 'flex';
                localStorage.setItem('hasVisitedBefore', 'true');
            }
        }

        function loadSettings() {
            // Load view mode
            const savedMode = localStorage.getItem('viewMode') || 'study';
            applyViewMode(savedMode);

            // Load dark mode
            const darkMode = localStorage.getItem('darkMode') === 'true';
            if (darkMode) {
                document.body.classList.add('dark-mode');
                document.getElementById('dark-mode-toggle').textContent = '‚òÄÔ∏è';
            }

            // Load toolbar collapsed state
            const toolbarCollapsed = localStorage.getItem('toolbarCollapsed') === 'true';
            if (toolbarCollapsed) {
                document.getElementById('toolbar-content').classList.add('collapsed');
                document.getElementById('toolbar-toggle').classList.add('collapsed');
                document.getElementById('toolbar-toggle').textContent = '‚ñ∂';
            }

            // Load font size
            const savedFontIndex = parseInt(localStorage.getItem('fontSizeIndex') || '1');
            if (window.fontSizeIndex !== undefined) {
                window.fontSizeIndex = savedFontIndex;
                window.updateFontSize();
            }

            // Load annotation set preference
            const savedAnnotationSet = localStorage.getItem('annotationSet') || 'Study';
            currentAnnotationSet = savedAnnotationSet;
            document.getElementById('annotation-set-select').value = savedAnnotationSet;

            // Load last chapter (will implement when folder is loaded)
            // We can't restore file handles from localStorage, but we can store book/chapter names
        }

        function saveSettings() {
            // View mode is saved when applyViewMode is called
            localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
            if (window.fontSizeIndex !== undefined) {
                localStorage.setItem('fontSizeIndex', window.fontSizeIndex);
            }
        }

        function setupEventListeners() {
            // Welcome modal
            document.getElementById('welcome-start').addEventListener('click', () => {
                document.getElementById('welcome-modal-overlay').style.display = 'none';
            });

            // Bug report
            document.getElementById('report-bug-link').addEventListener('click', (e) => {
                e.preventDefault();
                document.getElementById('bug-report-modal-overlay').style.display = 'flex';
            });

            document.getElementById('bug-cancel').addEventListener('click', () => {
                document.getElementById('bug-report-modal-overlay').style.display = 'none';
                document.getElementById('bug-report-form').reset();
            });

            document.getElementById('bug-close').addEventListener('click', () => {
                document.getElementById('bug-report-modal-overlay').style.display = 'none';
                document.getElementById('bug-report-form').reset();
                document.getElementById('bug-report-form').style.display = 'flex';
                document.getElementById('bug-success').style.display = 'none';
            });

            document.getElementById('bug-report-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                await submitBugReport();
            });

            // Folder selection
            document.getElementById('select-folder-btn').addEventListener('click', selectBibleFolder);
            document.getElementById('download-bible-btn').addEventListener('click', downloadBible);

            // Annotation set selector
            document.getElementById('annotation-set-select').addEventListener('change', onAnnotationSetChange);

            // Navigation
            document.getElementById('prev-chapter').addEventListener('click', goToPreviousChapter);
            document.getElementById('next-chapter').addEventListener('click', goToNextChapter);
            document.getElementById('book-select').addEventListener('change', onBookSelect);
            document.getElementById('chapter-select').addEventListener('change', onChapterSelect);

            // View modes
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.addEventListener('click', () => applyViewMode(btn.dataset.mode));
            });

            // Toolbar collapse
            document.getElementById('toolbar-toggle').addEventListener('click', function() {
                const content = document.getElementById('toolbar-content');
                content.classList.toggle('collapsed');
                this.classList.toggle('collapsed');
                this.textContent = content.classList.contains('collapsed') ? '‚ñ∂' : '‚ñº';

                // Save state
                localStorage.setItem('toolbarCollapsed', content.classList.contains('collapsed'));
            });

            // Settings collapse
            document.getElementById('settings-toggle').addEventListener('click', function() {
                const panel = document.getElementById('settings-panel');
                const icon = this.querySelector('.collapse-icon');
                panel.classList.toggle('collapsed');
                icon.classList.toggle('collapsed');
            });

            // Dark mode
            document.getElementById('dark-mode-toggle').addEventListener('click', function() {
                document.body.classList.toggle('dark-mode');
                this.textContent = document.body.classList.contains('dark-mode') ? '‚òÄÔ∏è' : 'üåô';
                saveSettings();
            });

            // Font controls
            const fontSizes = [14, 16, 18, 20, 22];
            const fontClasses = ['font-small', '', 'font-large', 'font-xlarge', 'font-xxlarge'];
            window.fontSizeIndex = 1;

            window.updateFontSize = function() {
                fontClasses.forEach(cls => {
                    if (cls) document.body.classList.remove(cls);
                });
                if (fontClasses[window.fontSizeIndex]) {
                    document.body.classList.add(fontClasses[window.fontSizeIndex]);
                }
                const percentage = Math.round((fontSizes[window.fontSizeIndex] / 16) * 100);
                document.getElementById('font-size-label').textContent = percentage + '%';
                document.getElementById('font-decrease').disabled = window.fontSizeIndex === 0;
                document.getElementById('font-increase').disabled = window.fontSizeIndex === fontSizes.length - 1;
                saveSettings();
            };

            document.getElementById('font-decrease').addEventListener('click', () => {
                if (window.fontSizeIndex > 0) {
                    window.fontSizeIndex--;
                    window.updateFontSize();
                }
            });

            document.getElementById('font-increase').addEventListener('click', () => {
                if (window.fontSizeIndex < fontSizes.length - 1) {
                    window.fontSizeIndex++;
                    window.updateFontSize();
                }
            });

            // Toggle controls
            setupToggleListeners();
        }

        function setupToggleListeners() {
            function switchToCustomMode() {
                if (!isProgrammaticChange && currentMode !== 'custom') {
                    currentMode = 'custom';
                    updateModeButtons();
                }
            }

            document.getElementById('toggle-highlights').addEventListener('change', function(e) {
                document.body.classList.toggle('show-highlights', e.target.checked);
                switchToCustomMode();
            });

            document.getElementById('toggle-notes').addEventListener('change', function(e) {
                document.body.classList.toggle('show-notes', e.target.checked);
                switchToCustomMode();
            });

            document.getElementById('toggle-note-bg').addEventListener('change', function(e) {
                if (e.target.checked) {
                    document.body.classList.add('note-style-highlighted');
                    document.body.classList.remove('note-style-plain');
                } else {
                    document.body.classList.add('note-style-plain');
                    document.body.classList.remove('note-style-highlighted');
                }
                switchToCustomMode();
            });

            document.getElementById('toggle-tags').addEventListener('change', function(e) {
                document.body.classList.toggle('show-tags', e.target.checked);
                switchToCustomMode();
            });

            document.getElementById('toggle-tag-bg').addEventListener('change', function(e) {
                if (e.target.checked) {
                    document.body.classList.add('tag-style-highlighted');
                    document.body.classList.remove('tag-style-plain');
                } else {
                    document.body.classList.add('tag-style-plain');
                    document.body.classList.remove('tag-style-highlighted');
                }
                switchToCustomMode();
            });

            document.getElementById('toggle-indicators').addEventListener('change', function(e) {
                document.body.classList.toggle('show-indicators', e.target.checked);
                switchToCustomMode();
            });

            document.getElementById('toggle-highlight-markers').addEventListener('change', function(e) {
                document.body.classList.toggle('show-highlight-markers', e.target.checked);
                switchToCustomMode();
            });

            document.getElementById('toggle-note-markers').addEventListener('change', function(e) {
                document.body.classList.toggle('show-note-markers', e.target.checked);
                switchToCustomMode();
            });

            document.getElementById('toggle-tag-markers').addEventListener('change', function(e) {
                document.body.classList.toggle('show-tag-markers', e.target.checked);
                switchToCustomMode();
            });

            document.getElementById('toggle-full-highlight').addEventListener('change', function(e) {
                if (e.target.checked) {
                    document.body.classList.add('highlight-mode-full');
                    document.body.classList.remove('highlight-mode-margin');
                } else {
                    document.body.classList.add('highlight-mode-margin');
                    document.body.classList.remove('highlight-mode-full');
                }
                switchToCustomMode();
            });
        }

        // ===== EDITING HANDLERS =====
        function setupEditingHandlers() {
            // Text selection for precise highlights
            document.addEventListener('mouseup', handleTextSelection);

            // Close floating toolbar when clicking outside
            document.addEventListener('click', (e) => {
                const toolbar = document.getElementById('floating-toolbar');
                if (!toolbar.contains(e.target) && !window.getSelection().toString()) {
                    toolbar.classList.remove('visible');
                }

                // Handle annotation delete (notes and tags only)
                if (e.target.classList.contains('annotation-delete')) {
                    const verse = e.target.dataset.verse;
                    const type = e.target.dataset.type;
                    const index = parseInt(e.target.dataset.index);

                    const verseAnnotations = getVerseAnnotations(verse);

                    // Delete specific note or tag
                    if (verseAnnotations[type + 's']) {
                        verseAnnotations[type + 's'].splice(index, 1);

                        // Update preview
                        updateVerseLivePreview(verse);

                        // Auto-save
                        autoSave();
                    }
                }
            });

            // Floating toolbar highlight buttons
            document.querySelectorAll('.highlight-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const color = e.target.dataset.color;
                    if (color === 'clear') {
                        // Just close toolbar without adding highlight
                        document.getElementById('floating-toolbar').classList.remove('visible');
                        window.getSelection().removeAllRanges();
                    } else {
                        applyPreciseHighlight(color);
                    }
                });
            });

            // Modal handlers
            setupModalHandlers();
        }

        function handleTextSelection(e) {
            const selection = window.getSelection();
            const selectedText = selection.toString().trim();

            if (!selectedText) {
                document.getElementById('floating-toolbar').classList.remove('visible');
                return;
            }

            // Get all verse containers that intersect with selection
            const range = selection.getRangeAt(0);
            const selectedVerses = [];

            // Find all verse-text elements in selection
            document.querySelectorAll('.verse-text').forEach(verseText => {
                const verseRange = document.createRange();
                verseRange.selectNodeContents(verseText);

                // Check if this verse intersects with selection
                if (range.intersectsNode(verseText)) {
                    selectedVerses.push(verseText.dataset.verse);
                }
            });

            if (selectedVerses.length === 0) {
                document.getElementById('floating-toolbar').classList.remove('visible');
                return;
            }

            // Store selected verses for highlighting
            currentSelectedVerse = selectedVerses[0]; // Use first verse for single-word highlights
            window.currentSelectedVerses = selectedVerses; // Store all for multi-verse
            window.currentSelectionText = selectedText;

            // Show floating toolbar near selection
            const rect = range.getBoundingClientRect();
            const toolbar = document.getElementById('floating-toolbar');

            toolbar.style.left = `${rect.left + window.scrollX}px`;
            toolbar.style.top = `${rect.bottom + window.scrollY + 10}px`;
            toolbar.classList.add('visible');
        }

        function applyPreciseHighlight(color) {
            const selection = window.getSelection();
            const selectedText = selection.toString().trim();
            const selectedVerses = window.currentSelectedVerses || [currentSelectedVerse];

            if (!selectedText) return;

            // Check if multi-verse selection
            if (selectedVerses.length > 1) {
                // Multi-verse: check for word highlight conflicts
                let hasWordHighlights = false;
                selectedVerses.forEach(verse => {
                    const verseAnnotations = getVerseAnnotations(verse);
                    if (verseAnnotations.highlights.some(h => !h.fullVerse)) {
                        hasWordHighlights = true;
                    }
                });

                if (hasWordHighlights) {
                    if (!confirm('One or more verses have word-specific highlights. Highlighting multiple verses will remove those word highlights. Continue?')) {
                        selection.removeAllRanges();
                        document.getElementById('floating-toolbar').classList.remove('visible');
                        return;
                    }
                }

                // Apply full verse highlight to each verse in selection
                selectedVerses.forEach(verse => {
                    const verseAnnotations = getVerseAnnotations(verse);

                    // Remove existing word highlights
                    verseAnnotations.highlights = verseAnnotations.highlights.filter(h => h.fullVerse);

                    // Add full verse highlight
                    verseAnnotations.highlights.push({
                        fullVerse: true,
                        color: color
                    });

                    updateVerseLivePreview(verse);
                });

                autoSave();
                console.log('Added multi-verse highlight:', { verses: selectedVerses, color });
            } else {
                // Single verse: word-level highlight
                const verse = selectedVerses[0];
                const verseAnnotations = getVerseAnnotations(verse);

                // Check for full verse highlight conflict
                const hasFullHighlight = verseAnnotations.highlights.some(h => h.fullVerse);
                if (hasFullHighlight) {
                    if (!confirm('This verse has a full verse highlight. Adding word highlights will remove the full verse highlight. Continue?')) {
                        selection.removeAllRanges();
                        document.getElementById('floating-toolbar').classList.remove('visible');
                        return;
                    }
                }

                // Check if highlighting same text (replace color)
                const existingIndex = verseAnnotations.highlights.findIndex(h => !h.fullVerse && h.text === selectedText);
                if (existingIndex >= 0) {
                    // Replace existing highlight of same text
                    verseAnnotations.highlights[existingIndex].color = color;
                } else {
                    // Remove any full verse highlights, add new word highlight
                    verseAnnotations.highlights = verseAnnotations.highlights.filter(h => !h.fullVerse);
                    verseAnnotations.highlights.push({
                        text: selectedText,
                        color: color
                    });
                }

                updateVerseLivePreview(verse);
                autoSave();
                console.log('Set word highlight:', { verse, text: selectedText, color });
            }

            // Hide toolbar
            document.getElementById('floating-toolbar').classList.remove('visible');
            selection.removeAllRanges();
        }

        function setupModalHandlers() {
            // Verse action buttons (highlight/note/tag) - delegated event
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('verse-action-btn')) {
                    const action = e.target.dataset.action;
                    const verse = e.target.dataset.verse;
                    currentSelectedVerse = verse;

                    if (action === 'highlight') {
                        showHighlightModal(verse);
                    } else if (action === 'note') {
                        showNoteModal(verse);
                    } else if (action === 'tag') {
                        showTagModal(verse);
                    }
                }
            });

            // Highlight modal
            document.querySelectorAll('.colour-option').forEach(option => {
                option.addEventListener('click', (e) => {
                    const color = e.target.dataset.color;
                    if (color === 'clear') {
                        clearVerseHighlight(currentSelectedVerse);
                    } else {
                        applyFullVerseHighlight(currentSelectedVerse, color);
                    }
                    closeModal('highlight-modal-overlay');
                });
            });

            document.getElementById('highlight-cancel').addEventListener('click', () => {
                closeModal('highlight-modal-overlay');
            });

            // Note modal
            function saveNote() {
                const verseRange = document.getElementById('note-verse-range').value.trim() || currentSelectedVerse;
                const noteText = document.getElementById('note-text').value.trim();

                if (noteText) {
                    addNote(verseRange, noteText);
                    closeModal('note-modal-overlay');
                    document.getElementById('note-verse-range').value = '';
                    document.getElementById('note-text').value = '';
                }
            }

            function cancelNote() {
                closeModal('note-modal-overlay');
                document.getElementById('note-verse-range').value = '';
                document.getElementById('note-text').value = '';
            }

            document.getElementById('note-save').addEventListener('click', saveNote);
            document.getElementById('note-cancel').addEventListener('click', cancelNote);

            // Note modal keyboard handlers
            document.getElementById('note-text').addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
                    e.preventDefault();
                    saveNote();
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    cancelNote();
                }
            });

            document.getElementById('note-verse-range').addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    e.preventDefault();
                    cancelNote();
                } else if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
                    e.preventDefault();
                    saveNote();
                }
            });

            // Tag modal with chip input
            let currentTags = [];

            document.getElementById('tag-text').addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
                    // Cmd/Ctrl+Enter saves and closes
                    e.preventDefault();
                    saveTag();
                } else if (e.key === 'Tab' || e.key === 'Enter') {
                    e.preventDefault();
                    const input = e.target;
                    const tagValue = input.value.trim();

                    if (tagValue) {
                        // Add # if not present
                        const tag = tagValue.startsWith('#') ? tagValue : `#${tagValue}`;
                        if (!currentTags.includes(tag)) {
                            currentTags.push(tag);
                            renderTagChips();
                        }
                        input.value = '';
                    }
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    cancelTag();
                }
            });

            function renderTagChips() {
                const container = document.getElementById('tag-chips');
                container.innerHTML = '';

                currentTags.forEach((tag, index) => {
                    const chip = document.createElement('div');
                    chip.className = 'tag-chip';
                    chip.innerHTML = `
                        <span>${tag}</span>
                        <span class="tag-chip-remove" data-index="${index}">√ó</span>
                    `;
                    container.appendChild(chip);
                });

                // Add click handlers for remove buttons
                document.querySelectorAll('.tag-chip-remove').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const index = parseInt(e.target.dataset.index);
                        currentTags.splice(index, 1);
                        renderTagChips();
                    });
                });
            }

            function saveTag() {
                const verseRange = document.getElementById('tag-verse-range').value.trim() || currentSelectedVerse;

                // Add any remaining text in input
                const remaining = document.getElementById('tag-text').value.trim();
                if (remaining) {
                    const tag = remaining.startsWith('#') ? remaining : `#${remaining}`;
                    if (!currentTags.includes(tag)) {
                        currentTags.push(tag);
                    }
                }

                if (currentTags.length > 0) {
                    const tagText = currentTags.join(' ');
                    addTags(verseRange, tagText);
                    closeModal('tag-modal-overlay');
                    document.getElementById('tag-verse-range').value = '';
                    document.getElementById('tag-text').value = '';
                    currentTags = [];
                    document.getElementById('tag-chips').innerHTML = '';
                }
            }

            function cancelTag() {
                closeModal('tag-modal-overlay');
                document.getElementById('tag-verse-range').value = '';
                document.getElementById('tag-text').value = '';
                currentTags = [];
                document.getElementById('tag-chips').innerHTML = '';
            }

            document.getElementById('tag-save').addEventListener('click', saveTag);
            document.getElementById('tag-cancel').addEventListener('click', cancelTag);

            // Tag modal keyboard handlers
            document.getElementById('tag-verse-range').addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    e.preventDefault();
                    cancelTag();
                } else if (e.key === 'Enter') {
                    if (e.ctrlKey || e.metaKey) {
                        e.preventDefault();
                        saveTag();
                    } else {
                        e.preventDefault();
                        saveTag();
                    }
                }
            });

        }

        function showHighlightModal(verse) {
            currentSelectedVerse = verse;
            document.getElementById('highlight-modal-overlay').classList.add('visible');
        }

        function showNoteModal(verse) {
            currentSelectedVerse = verse;
            document.getElementById('note-verse-range').placeholder = `Current: ${verse}`;
            document.getElementById('note-modal-overlay').classList.add('visible');
            document.getElementById('note-text').focus();
        }

        function showTagModal(verse) {
            currentSelectedVerse = verse;
            document.getElementById('tag-verse-range').placeholder = `Current: ${verse}`;
            document.getElementById('tag-modal-overlay').classList.add('visible');
            document.getElementById('tag-text').focus();
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('visible');
        }

        function applyFullVerseHighlight(verse, color) {
            const verseAnnotations = getVerseAnnotations(verse);

            // Check for word highlight conflict
            const hasWordHighlights = verseAnnotations.highlights.some(h => !h.fullVerse);
            if (hasWordHighlights) {
                if (!confirm('This verse has word-specific highlights. Adding a full verse highlight will remove them. Continue?')) {
                    return;
                }
            }

            // Replace all existing highlights with new one
            verseAnnotations.highlights = [{
                fullVerse: true,
                color: color
            }];

            updateVerseLivePreview(verse);
            autoSave();

            console.log('Set full verse highlight:', { verse, color });
        }

        function clearVerseHighlight(verse) {
            const verseAnnotations = getVerseAnnotations(verse);

            // Clear highlights
            verseAnnotations.highlights = [];

            // Update preview
            updateVerseLivePreview(verse);

            // Auto-save
            autoSave();

            console.log('Cleared highlights:', { verse });
        }

        function addNote(verseRange, noteText) {
            const verses = parseVerseRangeString(verseRange);

            // Add note only to the last verse in range
            const lastVerse = verses[verses.length - 1];
            const verseAnnotations = getVerseAnnotations(lastVerse);

            verseAnnotations.notes.push({
                verseRange: verseRange,
                text: noteText
            });

            updateVerseLivePreview(lastVerse);
            autoSave();

            console.log('Added note:', { verseRange, noteText });
        }

        function addTags(verseRange, tagText) {
            const verses = parseVerseRangeString(verseRange);

            verses.forEach(verse => {
                const verseAnnotations = getVerseAnnotations(verse);

                verseAnnotations.tags.push({
                    verseRange: verseRange,
                    text: tagText
                });

                updateVerseLivePreview(verse);
            });

            autoSave();
            console.log('Added tags:', { verseRange, tagText });
        }

        function parseVerseRangeString(rangeStr) {
            // Parse "3", "3-5", "3,7,12" into array of verse numbers
            if (!rangeStr) return [];

            if (rangeStr.includes('-')) {
                const [start, end] = rangeStr.split('-').map(v => parseInt(v.trim()));
                const verses = [];
                for (let i = start; i <= end; i++) {
                    verses.push(i.toString());
                }
                return verses;
            } else if (rangeStr.includes(',')) {
                return rangeStr.split(',').map(v => v.trim());
            } else {
                return [rangeStr];
            }
        }

        function markVerseAsUnsaved(verse) {
            // Update live preview of the verse
            updateVerseLivePreview(verse);
        }

        function updateVerseLivePreview(verse) {
            // Find the verse container
            const containers = document.querySelectorAll(`.verse-container[data-verse="${verse}"]`);

            containers.forEach(container => {
                const verseTextDiv = container.querySelector('.verse-text');
                if (!verseTextDiv) return;

                // Get original text (strip existing highlights/spans)
                let text = verseTextDiv.textContent;

                // Remove indicators from text
                text = text.replace(/[‚ìù‚ì£]/g, '').trim();

                // Get annotations from currentAnnotations (single source of truth)
                const chapterName = getChapterNameFromMarkdown(currentOriginalMarkdown);
                const verseData = (currentAnnotations?.chapters?.[chapterName]?.verses?.[verse]) || { highlights: [], notes: [], tags: [] };

                const highlights = verseData.highlights || [];
                const notes = verseData.notes || [];
                const tags = verseData.tags || [];

                // Apply highlights
                if (highlights.length > 0) {
                    highlights.forEach(h => {
                        if (h.fullVerse) {
                            // Wrap entire text in highlight
                            text = `<span class="highlight-${h.color}">${text}</span>`;
                        } else {
                            // Highlight specific text
                            const regex = new RegExp(`(${escapeRegex(h.text)})`, 'gi');
                            text = text.replace(regex, `<span class="highlight-${h.color}">$1</span>`);
                        }
                    });
                }

                // Update CSS classes on verse container
                const hasHighlight = highlights.length > 0;
                const hasNotes = notes.length > 0;
                const hasTags = tags.length > 0;

                // Update classes on verse-text div
                let classes = 'verse-text';
                if (hasHighlight) classes += ' has-highlight';
                if (hasNotes) classes += ' has-note';
                if (hasTags) classes += ' has-tag';
                verseTextDiv.className = classes;
                verseTextDiv.setAttribute('data-verse', verse);

                // Add indicators for notes/tags
                let indicators = '';
                if (hasNotes || hasTags) {
                    indicators = '<span class="verse-indicators">';
                    if (hasNotes) indicators += '<span class="indicator-note">‚ìù</span>';
                    if (hasTags) indicators += '<span class="indicator-tag">‚ì£</span>';
                    indicators += '</span>';
                }

                verseTextDiv.innerHTML = text + indicators;

                // Add note/tag blocks below verse if they exist
                removeUnsavedAnnotations(container);

                if (hasNotes) {
                    notes.forEach((note, noteIndex) => {
                        const noteDiv = document.createElement('div');
                        noteDiv.className = 'note unsaved-annotation';
                        const verseLabel = note.verseRange && (note.verseRange.includes('-') || note.verseRange.includes(','))
                            ? `Verses ${note.verseRange}`
                            : note.verseRange ? `Verse ${note.verseRange}` : '';
                        noteDiv.innerHTML = `
                            ${verseLabel ? `<span class="note-verses">${verseLabel}</span>` : ''}
                            <span class="annotation-delete" data-verse="${verse}" data-type="note" data-index="${noteIndex}" title="Delete note">üóëÔ∏è</span>
                            <div>${note.text}</div>
                        `;
                        container.after(noteDiv);
                    });
                }

                if (hasTags) {
                    tags.forEach((tag, tagIndex) => {
                        const tagDiv = document.createElement('div');
                        tagDiv.className = 'tags unsaved-annotation';
                        const tagText = tag.text || tag;
                        const tagList = (typeof tagText === 'string' ? tagText : '').split(/\s+/).filter(t => t.startsWith('#'));
                        tagDiv.innerHTML = tagList.map(t => `<span class="tag">${t}</span>`).join('') +
                            `<span class="annotation-delete" data-verse="${verse}" data-type="tag" data-index="${tagIndex}" title="Delete tags">üóëÔ∏è</span>`;
                        container.after(tagDiv);
                    });
                }
            });
        }

        function removeUnsavedAnnotations(container) {
            // Remove any previously added unsaved notes/tags
            let next = container.nextElementSibling;
            while (next && next.classList.contains('unsaved-annotation')) {
                const toRemove = next;
                next = next.nextElementSibling;
                toRemove.remove();
            }
        }

        function escapeRegex(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        // Helper function to get or create verse annotation object
        function getVerseAnnotations(verse) {
            const chapterName = getChapterNameFromMarkdown(currentOriginalMarkdown);

            // Ensure chapter exists in annotations
            if (!currentAnnotations.chapters) {
                currentAnnotations.chapters = {};
            }
            if (!currentAnnotations.chapters[chapterName]) {
                currentAnnotations.chapters[chapterName] = { verses: {} };
            }
            if (!currentAnnotations.chapters[chapterName].verses[verse]) {
                currentAnnotations.chapters[chapterName].verses[verse] = {
                    highlights: [],
                    notes: [],
                    tags: []
                };
            }

            return currentAnnotations.chapters[chapterName].verses[verse];
        }

        // Auto-save functions
        function showSaveStatus(status) {
            const statusEl = document.getElementById('save-status');

            // Clear any existing timeout
            clearTimeout(saveStatusTimeout);

            // Remove all status classes
            statusEl.classList.remove('saving', 'saved');

            if (status === 'saving') {
                statusEl.textContent = 'Saving...';
                statusEl.classList.add('saving', 'visible');
            } else if (status === 'saved') {
                statusEl.textContent = 'Saved';
                statusEl.classList.add('saved', 'visible');

                // Hide after 2 seconds
                saveStatusTimeout = setTimeout(() => {
                    statusEl.classList.remove('visible');
                }, 2000);
            }
        }

        function autoSave() {
            // Debounce: wait 500ms after last change before saving
            clearTimeout(saveTimeout);

            saveTimeout = setTimeout(async () => {
                showSaveStatus('saving');

                try {
                    await saveAnnotationsForBook();
                    showSaveStatus('saved');
                    console.log('Auto-saved annotations');
                } catch (error) {
                    console.error('Auto-save failed:', error);
                    // Show error briefly
                    const statusEl = document.getElementById('save-status');
                    statusEl.textContent = 'Save failed';
                    statusEl.classList.remove('saving', 'saved');
                    statusEl.classList.add('visible');
                    setTimeout(() => statusEl.classList.remove('visible'), 3000);
                }
            }, 500);
        }


        // View mode management
        const viewModes = {
            reading: {
                highlights: false,
                highlightMarkers: false,
                notes: false,
                noteBg: false,
                noteMarkers: false,
                tags: false,
                tagBg: false,
                tagMarkers: false,
                indicators: false,
                fullHighlight: false
            },
            study: {
                highlights: true,
                highlightMarkers: true,
                notes: true,
                noteBg: true,
                noteMarkers: true,
                tags: true,
                tagBg: true,
                tagMarkers: true,
                indicators: true,
                fullHighlight: false
            },
            church: {
                highlights: false,
                highlightMarkers: false,
                notes: false,
                noteBg: false,
                noteMarkers: true,
                tags: false,
                tagBg: false,
                tagMarkers: false,
                indicators: false,
                fullHighlight: false
            }
        };

        function applyViewMode(mode) {
            if (mode === 'custom') {
                currentMode = 'custom';
                updateModeButtons();
                const panel = document.getElementById('settings-panel');
                const icon = document.querySelector('.collapse-icon');
                if (panel.classList.contains('collapsed')) {
                    panel.classList.remove('collapsed');
                    icon.classList.remove('collapsed');
                }
                return;
            }

            if (currentMode === mode) return;

            const config = viewModes[mode];
            if (!config) return;

            currentMode = mode;
            isProgrammaticChange = true;

            document.getElementById('toggle-highlights').checked = config.highlights;
            document.getElementById('toggle-highlight-markers').checked = config.highlightMarkers;
            document.getElementById('toggle-notes').checked = config.notes;
            document.getElementById('toggle-note-bg').checked = config.noteBg;
            document.getElementById('toggle-note-markers').checked = config.noteMarkers;
            document.getElementById('toggle-tags').checked = config.tags;
            document.getElementById('toggle-tag-bg').checked = config.tagBg;
            document.getElementById('toggle-tag-markers').checked = config.tagMarkers;
            document.getElementById('toggle-indicators').checked = config.indicators;
            document.getElementById('toggle-full-highlight').checked = config.fullHighlight;

            document.getElementById('toggle-highlights').dispatchEvent(new Event('change'));
            document.getElementById('toggle-highlight-markers').dispatchEvent(new Event('change'));
            document.getElementById('toggle-notes').dispatchEvent(new Event('change'));
            document.getElementById('toggle-note-bg').dispatchEvent(new Event('change'));
            document.getElementById('toggle-note-markers').dispatchEvent(new Event('change'));
            document.getElementById('toggle-tags').dispatchEvent(new Event('change'));
            document.getElementById('toggle-tag-bg').dispatchEvent(new Event('change'));
            document.getElementById('toggle-tag-markers').dispatchEvent(new Event('change'));
            document.getElementById('toggle-indicators').dispatchEvent(new Event('change'));
            document.getElementById('toggle-full-highlight').dispatchEvent(new Event('change'));

            isProgrammaticChange = false;
            updateModeButtons();
            localStorage.setItem('viewMode', mode);
        }

        function updateModeButtons() {
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.mode === currentMode);
            });
        }

        function tryRestoreLastChapter() {
            const lastBook = localStorage.getItem('lastBook');
            const lastChapter = localStorage.getItem('lastChapter');

            if (!lastBook || !lastChapter) return null;

            // Try to find the chapter file
            const found = fileIndex.find(file => {
                const bookMatch = file.path.match(/^([^\/]+)/);
                const chapterName = file.displayName.split('/').pop();
                return bookMatch && bookMatch[1] === lastBook && chapterName === lastChapter;
            });

            return found;
        }

        // Annotation System
        async function onAnnotationSetChange(e) {
            const newSet = e.target.value;
            currentAnnotationSet = newSet;
            localStorage.setItem('annotationSet', newSet);

            // Reload current chapter with new annotation set
            if (currentFile) {
                await loadChapter(currentFile);
            }
        }

        async function loadAnnotationsForBook(bookName) {
            try {
                // Navigate to .annotations folder at Bible root
                const annotationsFolder = await bibleFolder.getDirectoryHandle('.annotations', { create: true });

                // Get or create annotation set folder (Study/Church/etc.)
                const setFolder = await annotationsFolder.getDirectoryHandle(currentAnnotationSet, { create: true });

                // File naming: book number + book name (e.g., "046-1-Peter.json")
                const filename = `${bookName.replace(/ /g, '-')}.json`;

                try {
                    const fileHandle = await setFolder.getFileHandle(filename);
                    const file = await fileHandle.getFile();
                    const text = await file.text();
                    currentAnnotations = JSON.parse(text);
                    console.log(`Loaded annotations from .annotations/${currentAnnotationSet}/${filename}:`, currentAnnotations);
                } catch (err) {
                    // File doesn't exist - create new
                    console.log(`No annotations file found, creating new for ${bookName}`);
                    currentAnnotations = {
                        version: "1.0",
                        annotationSet: currentAnnotationSet,
                        bookName: bookName,
                        created: new Date().toISOString(),
                        modified: new Date().toISOString(),
                        chapters: {}
                    };
                }
            } catch (err) {
                console.error('Error loading annotations:', err);
                currentAnnotations = {
                    version: "1.0",
                    annotationSet: currentAnnotationSet,
                    bookName: bookName,
                    created: new Date().toISOString(),
                    modified: new Date().toISOString(),
                    chapters: {}
                };
            }
        }

        async function saveAnnotationsForBook() {
            try {
                // Navigate to .annotations folder at Bible root
                const annotationsFolder = await bibleFolder.getDirectoryHandle('.annotations', { create: true });

                // Get or create annotation set folder (Study/Church/etc.)
                const setFolder = await annotationsFolder.getDirectoryHandle(currentAnnotationSet, { create: true });

                // Get current book name from annotations or current file
                const bookName = currentAnnotations.bookName || getCurrentBookName();
                const filename = `${bookName.replace(/ /g, '-')}.json`;

                // Update modified timestamp
                currentAnnotations.modified = new Date().toISOString();
                currentAnnotations.bookName = bookName;

                // Save to file
                const fileHandle = await setFolder.getFileHandle(filename, { create: true });
                const writable = await fileHandle.createWritable();
                await writable.write(JSON.stringify(currentAnnotations, null, 2));
                await writable.close();

                console.log(`Saved annotations to .annotations/${currentAnnotationSet}/${filename}`);
                return true;
            } catch (err) {
                console.error('Error saving annotations:', err);
                alert('Error saving annotations: ' + err.message);
                return false;
            }
        }

        function getCurrentBookName() {
            // Extract book name from current file path
            if (currentFile && currentFile.path) {
                const bookMatch = currentFile.path.match(/^([^\/]+)/);
                return bookMatch ? bookMatch[1] : 'Unknown';
            }
            return 'Unknown';
        }

        function getAnnotationsForChapter(chapterName) {
            if (!currentAnnotations.chapters) {
                currentAnnotations.chapters = {};
            }

            if (!currentAnnotations.chapters[chapterName]) {
                currentAnnotations.chapters[chapterName] = { verses: {} };
            }

            return currentAnnotations.chapters[chapterName];
        }

        // File System Access
        async function selectBibleFolder() {
            try {
                const dirHandle = await window.showDirectoryPicker({
                    mode: 'readwrite',
                    startIn: 'documents'
                });

                bibleFolder = dirHandle;
                await indexBibleFolder(dirHandle);

                // Hide welcome, show content
                document.getElementById('welcome-screen').classList.add('hidden');
                document.getElementById('navigation').classList.remove('hidden');
                document.getElementById('content').classList.remove('hidden');

                // Load last chapter or first chapter
                if (fileIndex.length > 0) {
                    const lastChapter = tryRestoreLastChapter();
                    await loadChapter(lastChapter || fileIndex[0]);
                }
            } catch (err) {
                if (err.name !== 'AbortError') {
                    console.error('Error selecting folder:', err);
                    alert('Error accessing folder. Please try again.');
                }
            }
        }

        async function indexBibleFolder(dirHandle) {
            fileIndex = [];
            bookIndex = {};

            try {
                // Recursively scan for .md files
                await scanDirectory(dirHandle, '');

                // Sort by book number and chapter
                fileIndex.sort((a, b) => {
                    const aNum = parseInt(a.path.match(/\d+/)?.[0] || '999');
                    const bNum = parseInt(b.path.match(/\d+/)?.[0] || '999');
                    return aNum - bNum || a.path.localeCompare(b.path);
                });

                // Organize into books
                fileIndex.forEach((file, index) => {
                    file.index = index;

                    // Use the bookName we tracked during scanning
                    if (file.bookName) {
                        if (!bookIndex[file.bookName]) {
                            bookIndex[file.bookName] = [];
                        }
                        bookIndex[file.bookName].push(file);
                    }
                });

                // Populate book selector
                const bookSelect = document.getElementById('book-select');
                bookSelect.innerHTML = '<option value="">Select a book...</option>';

                Object.keys(bookIndex).sort().forEach(bookName => {
                    const option = document.createElement('option');
                    option.value = bookName;
                    option.textContent = bookName;
                    bookSelect.appendChild(option);
                });

                console.log(`Indexed ${fileIndex.length} chapters in ${Object.keys(bookIndex).length} books`);
            } catch (err) {
                console.error('Error indexing folder:', err);
                alert('Error reading Bible folder structure.');
            }
        }

        async function scanDirectory(dirHandle, path, bookName = null) {
            // Skip patterns
            const skipPatterns = ['template', 'temp', '_draft', 'scratch', 'test', 'README'];

            for await (const entry of dirHandle.values()) {
                // Skip hidden files/folders (start with .)
                if (entry.name.startsWith('.')) {
                    continue;
                }

                // Skip files/folders matching skip patterns
                const nameLower = entry.name.toLowerCase();
                if (skipPatterns.some(pattern => nameLower.includes(pattern.toLowerCase()))) {
                    continue;
                }

                if (entry.kind === 'file' && entry.name.endsWith('.md')) {
                    // Found a markdown file
                    const displayName = path ? `${path}/${entry.name}` : entry.name;

                    // Determine book name from path hierarchy
                    // If we're inside a numbered folder (e.g., "001 - Genesis"), use that
                    let currentBookName = bookName;
                    if (!currentBookName && path) {
                        // Extract the book folder (looks for pattern like "001 - Genesis")
                        const bookMatch = path.match(/(\d{3}\s*-\s*[^\/]+)/);
                        if (bookMatch) {
                            currentBookName = bookMatch[1];
                        }
                    }

                    fileIndex.push({
                        handle: entry,
                        path: displayName,
                        displayName: displayName.replace('.md', ''),
                        bookName: currentBookName
                    });
                } else if (entry.kind === 'directory') {
                    const newPath = path ? `${path}/${entry.name}` : entry.name;

                    // Check if this directory is a book folder (e.g., "001 - Genesis")
                    let newBookName = bookName;
                    if (/^\d{3}\s*-\s*.+/.test(entry.name)) {
                        newBookName = entry.name;
                    }

                    await scanDirectory(entry, newPath, newBookName);
                }
            }
        }

        async function loadChapter(fileInfo) {
            try {
                currentFile = fileInfo;
                currentFileHandle = fileInfo.handle;

                // Load the original markdown file (read-only)
                const file = await fileInfo.handle.getFile();
                const content = await file.text();
                currentOriginalMarkdown = content;

                // Load annotations for this book
                const bookMatch = fileInfo.path.match(/^([^\/]+)/);
                if (bookMatch) {
                    const bookName = bookMatch[1];
                    await loadAnnotationsForBook(bookName);
                }

                // Render markdown with annotations applied
                renderMarkdown(content);

                // Update selectors
                if (bookMatch) {
                    const bookName = bookMatch[1];
                    document.getElementById('book-select').value = bookName;
                    updateChapterSelector(bookName);
                    document.getElementById('chapter-select').value = fileInfo.index;

                    // Save last chapter for next session
                    const chapterName = fileInfo.displayName.split('/').pop();
                    localStorage.setItem('lastBook', bookName);
                    localStorage.setItem('lastChapter', chapterName);
                }

                // Update prev/next buttons
                document.getElementById('prev-chapter').disabled = fileInfo.index === 0;
                document.getElementById('next-chapter').disabled = fileInfo.index === fileIndex.length - 1;
            } catch (err) {
                console.error('Error loading chapter:', err);
                alert('Error loading chapter file.');
            }
        }

        function onBookSelect(e) {
            const bookName = e.target.value;
            if (bookName) {
                updateChapterSelector(bookName);
            }
        }

        function updateChapterSelector(bookName) {
            const chapterSelect = document.getElementById('chapter-select');
            chapterSelect.innerHTML = '<option value="">Select a chapter...</option>';

            if (bookIndex[bookName]) {
                // Sort chapters: book file first, then numbered chapters
                const sortedChapters = [...bookIndex[bookName]].sort((a, b) => {
                    const aName = a.displayName.split('/').pop();
                    const bName = b.displayName.split('/').pop();

                    // Check if either is the book overview file (no number)
                    const aIsBook = !/\d/.test(aName);
                    const bIsBook = !/\d/.test(bName);

                    if (aIsBook && !bIsBook) return -1; // Book file comes first
                    if (!aIsBook && bIsBook) return 1;  // Chapter comes after

                    // Both are chapters, sort numerically
                    const aNum = parseInt(aName.match(/\d+/)?.[0] || '999');
                    const bNum = parseInt(bName.match(/\d+/)?.[0] || '999');
                    return aNum - bNum;
                });

                sortedChapters.forEach(file => {
                    const option = document.createElement('option');
                    option.value = file.index;
                    // Extract just the chapter name from path
                    const chapterName = file.displayName.split('/').pop();
                    option.textContent = chapterName;
                    chapterSelect.appendChild(option);
                });
            }
        }

        function goToPreviousChapter() {
            if (currentFile && currentFile.index > 0) {
                loadChapter(fileIndex[currentFile.index - 1]);
            }
        }

        function goToNextChapter() {
            if (currentFile && currentFile.index < fileIndex.length - 1) {
                loadChapter(fileIndex[currentFile.index + 1]);
            }
        }

        function onChapterSelect(e) {
            const index = parseInt(e.target.value);
            if (!isNaN(index) && fileIndex[index]) {
                loadChapter(fileIndex[index]);
            }
        }

        function downloadBible() {
            alert('Bible download feature coming soon! For now, please prepare your own markdown Bible files.');
            // TODO: Implement Bible download/bundling
        }

        async function submitBugReport() {
            const description = document.getElementById('bug-description').value;
            const steps = document.getElementById('bug-steps').value;
            const email = document.getElementById('bug-email').value;

            const bugData = {
                description,
                steps,
                email: email || 'Not provided',
                userAgent: navigator.userAgent,
                timestamp: new Date().toISOString(),
                version: '1.0.0'
            };

            try {
                // Using Formspree for bug reports
                const response = await fetch('https://formspree.io/f/mblqkwye', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(bugData)
                });

                if (response.ok) {
                    document.getElementById('bug-report-form').style.display = 'none';
                    document.getElementById('bug-success').style.display = 'block';
                } else {
                    alert('Error submitting bug report. Please try again or email directly.');
                }
            } catch (error) {
                console.error('Bug report error:', error);
                // Fallback: copy to clipboard
                const reportText = `Bug Report\n\nDescription: ${description}\n\nSteps: ${steps}\n\nEmail: ${email}\n\nUser Agent: ${navigator.userAgent}\n\nVersion: 1.0.0`;

                try {
                    await navigator.clipboard.writeText(reportText);
                    alert('Could not submit online. Bug report copied to clipboard - please email to bugs@scripturescribbles.co.uk');
                } catch {
                    alert('Please email bug reports to: bugs@scripturescribbles.co.uk\n\n' + reportText);
                }
            }
        }

        // Markdown rendering (same as prototype)
        function renderMarkdown(input) {
            const lines = input.split('\n');
            let html = '';
            let currentVerse = null;

            // Get chapter name from H1 heading
            const chapterName = getChapterNameFromMarkdown(input);

            // Get annotations for this chapter (from JSON or unsaved edits)
            const chapterAnnotations = getAnnotationsForChapter(chapterName);
            const verseData = chapterAnnotations.verses || {};

            // Build lookup maps for has-* classes
            let verseNotes = {};
            let verseTags = {};
            let verseHighlights = {};

            // Build lookup maps from saved annotations (single source of truth)
            Object.keys(verseData).forEach(verseNum => {
                const v = parseInt(verseNum);
                if (verseData[verseNum].highlights && verseData[verseNum].highlights.length > 0) {
                    verseHighlights[v] = true;
                }
                if (verseData[verseNum].notes && verseData[verseNum].notes.length > 0) {
                    verseNotes[v] = true;
                }
                if (verseData[verseNum].tags && verseData[verseNum].tags.length > 0) {
                    verseTags[v] = true;
                }
            });

            // Second pass - render
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;

                if (line.startsWith('# ') && !line.startsWith('##')) {
                    html += `<h1>${line.substring(2)}</h1>`;
                    continue;
                }

                if (line.includes('[[') && line.includes('center-me')) {
                    const navText = line.replace(/<span class="center-me">|<\/span>/g, '');
                    html += `<div class="center-me">${processWikiLinks(navText)}</div>`;
                    continue;
                }

                if (line.startsWith('###### ')) {
                    const verseNum = line.substring(7).trim();
                    currentVerse = verseNum;

                    let verseText = '';
                    if (i + 1 < lines.length) {
                        verseText = lines[i + 1].trim();
                        i++;
                    }

                    // Apply highlights from JSON annotations + unsaved edits
                    verseText = applyHighlightsFromJSON(verseText, currentVerse, verseData);

                    const hasHighlight = verseHighlights[parseInt(currentVerse)];
                    const hasNote = verseNotes[parseInt(currentVerse)];
                    const hasTag = verseTags[parseInt(currentVerse)];

                    let indicators = '';
                    if (hasNote || hasTag) {
                        indicators = '<span class="verse-indicators">';
                        if (hasNote) indicators += '<span class="indicator-note">‚ìù</span>';
                        if (hasTag) indicators += '<span class="indicator-tag">‚ì£</span>';
                        indicators += '</span>';
                    }

                    let classes = 'verse-text';
                    if (hasHighlight) classes += ' has-highlight';
                    if (hasNote) classes += ' has-note';
                    if (hasTag) classes += ' has-tag';

                    html += `
                        <div class="verse-container" data-verse="${verseNum}">
                            <div class="verse-actions">
                                <button class="verse-action-btn" data-action="highlight" data-verse="${verseNum}" title="Highlight verse">üé®</button>
                                <button class="verse-action-btn" data-action="note" data-verse="${verseNum}" title="Add note">üìù</button>
                                <button class="verse-action-btn" data-action="tag" data-verse="${verseNum}" title="Add tags">üè∑Ô∏è</button>
                            </div>
                            <div class="verse-number">${verseNum}</div>
                            <div class="${classes}" data-verse="${verseNum}">${verseText}${indicators}</div>
                        </div>
                    `;

                    // After verse, check for notes and tags from JSON
                    const verseNumInt = parseInt(currentVerse);

                    // Get saved annotations (single source of truth)
                    const savedVerse = verseData[verseNumInt] || {};

                    // Render notes
                    const allNotes = savedVerse.notes || [];
                    allNotes.forEach(note => {
                        let verseLabel = '';
                        if (note.verseRange && note.verseRange !== verseNumInt.toString()) {
                            const parsed = parseVerseReference(note.verseRange);
                            if (parsed) {
                                verseLabel = formatVerseLabel(parsed);
                            }
                        }

                        html += `
                            <div class="note">
                                ${verseLabel ? `<div class="note-verses">${verseLabel}</div>` : ''}
                                ${processWikiLinks(note.text)}
                            </div>
                        `;
                    });

                    // Render tags
                    const allTags = savedVerse.tags || [];
                    if (allTags.length > 0) {
                        html += `
                            <div class="tags">
                                ${allTags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                            </div>
                        `;
                    }

                    continue;
                }
            }

            document.getElementById('content').innerHTML = html;
        }

        function getChapterNameFromMarkdown(markdown) {
            // Extract chapter name from H1 heading (e.g., "# 1 Peter 2")
            const h1Match = markdown.match(/^#\s+(.+)$/m);
            return h1Match ? h1Match[1].trim() : 'Unknown Chapter';
        }

        function applyHighlightsFromJSON(text, verseNum, verseData) {
            const verseNumInt = parseInt(verseNum);

            // Get highlights from saved annotations only (single source of truth)
            const savedVerse = verseData[verseNumInt] || {};

            const allHighlights = savedVerse.highlights || [];

            if (allHighlights.length === 0) {
                return text;
            }

            // Sort highlights by offset (if word-level) to apply from end to start (avoids offset issues)
            allHighlights.sort((a, b) => (b.offset || 0) - (a.offset || 0));

            let result = text;

            allHighlights.forEach(highlight => {
                if (highlight.fullVerse) {
                    // Full verse highlight - wrap entire text
                    result = `<span class="highlight-${highlight.color}">${result}</span>`;
                } else {
                    // Word-level highlight - find and wrap specific text
                    if (highlight.text) {
                        const regex = new RegExp(`(${escapeRegex(highlight.text)})`, 'i');
                        result = result.replace(regex, `<span class="highlight-${highlight.color}">$1</span>`);
                    }
                }
            });

            return result;
        }

        function escapeRegex(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        function parseVerseReference(ref) {
            if (!ref) return null;

            if (ref.includes(':')) {
                return { type: 'cross-chapter', ref };
            }

            if (ref.includes(',')) {
                return { type: 'multiple', verses: ref.split(',').map(v => parseInt(v.trim())) };
            }

            if (ref.includes('-')) {
                const [start, end] = ref.split('-').map(v => parseInt(v.trim()));
                return { type: 'range', start, end };
            }

            return { type: 'single', verse: parseInt(ref) };
        }

        function markVerses(parsed, targetObj) {
            if (parsed.type === 'single') {
                targetObj[parsed.verse] = true;
            } else if (parsed.type === 'range') {
                for (let v = parsed.start; v <= parsed.end; v++) {
                    targetObj[v] = true;
                }
            } else if (parsed.type === 'multiple') {
                parsed.verses.forEach(v => targetObj[v] = true);
            }
        }

        function formatVerseLabel(parsed) {
            if (parsed.type === 'single') {
                return `Verse ${parsed.verse}`;
            } else if (parsed.type === 'range') {
                return `Verses ${parsed.start}-${parsed.end}`;
            } else if (parsed.type === 'multiple') {
                return `Verses ${parsed.verses.join(', ')}`;
            } else if (parsed.type === 'cross-chapter') {
                return parsed.ref;
            }
            return '';
        }

        function processHighlights(text, verseNum) {
            const regex = /¬±(\d)(\d+(?:-\d+)?(?:,\d+)*)?{(.+?)}/g;
            return text.replace(regex, (match, color, verses, content) => {
                return `<span class="highlight-${color}">${content}</span>`;
            });
        }

        function processWikiLinks(text) {
            return text.replace(/\[\[([^\]|]+)(?:\|([^\]]+))?\]\]/g, function(match, link, display) {
                const displayText = display || link;
                return `<a href="#" class="wikilink" data-link="${link}" onclick="handleWikiLink('${link}', event); return false;">${displayText}</a>`;
            });
        }

        function handleWikiLink(link, event) {
            event.preventDefault();

            // Try to find the chapter file by searching displayName
            const targetFile = fileIndex.find(file => {
                const displayName = file.displayName.split('/').pop(); // Get just the filename part

                // Exact match (case-insensitive)
                if (displayName.toLowerCase() === link.toLowerCase()) {
                    return true;
                }

                // Match without .md extension
                if (displayName.toLowerCase().replace('.md', '') === link.toLowerCase()) {
                    return true;
                }

                return false;
            });

            if (targetFile) {
                loadChapter(targetFile);
            } else {
                alert(`Could not find chapter: "${link}"\n\nMake sure the chapter file exists in your Bible folder.`);
                console.log('WikiLink search failed for:', link);
                console.log('Available files:', fileIndex.map(f => f.displayName));
            }
        }
    </script>
</body>
</html>
